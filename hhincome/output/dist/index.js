define(["esri/WebMap","esri/views/MapView","esri/widgets/Expand","esri/widgets/Legend","esri/core/promiseUtils","esri/core/watchUtils","esri/renderers/smartMapping/statistics/histogram","esri/renderers/smartMapping/statistics/summaryStatistics","esri/widgets/HistogramRangeSlider"],(function(e,t,n,s,a,c,r,d,o){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,s=s&&s.hasOwnProperty("default")?s.default:s,c=c&&c.hasOwnProperty("default")?c.default:c,r=r&&r.hasOwnProperty("default")?r.default:r,d=d&&d.hasOwnProperty("default")?d.default:d,o=o&&o.hasOwnProperty("default")?o.default:o;const l=()=>{};let i;let u,m=[],p=[],y=[];const h=Array.from(document.querySelectorAll(".hhP")),g=Array.from(document.querySelectorAll(".clapP")),f=Array.from(document.querySelectorAll(".snareP")),w=Array.from(document.querySelectorAll(".bassP")),I=document.getElementById("hhPattern"),C=document.getElementById("cPattern"),v=document.getElementById("sPattern"),E=document.getElementById("bPattern"),_=document.getElementById("hhDelay"),P=document.getElementById("clapDelay"),B=document.getElementById("snareDelay"),S=document.getElementById("bassDelay"),F=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),k=new p5.SoundFile("assets/808-open-hat-1.mp3",l),D=new p5.SoundFile("assets/808-clap.mp3",l),b=new p5.SoundFile("assets/processed-909.mp3",l),A=new p5.SoundFile("assets/808-snare-drum-1.mp3",l),H=[0,1,0,1,0,1,0,1,0,1],N=[0,0,0,1,0,0,1,0,1,0],T=[0,1,0,1,0,1,0,1,0,0],Y=[0,0,1,0,0,1,0,0,1,0];function L({elements:e,pattern:t}){for(const n in e){const s=e[n];s.classList.remove("is-active"),t[n]&&s.classList.add("is-active")}}window.setup=function(){let l;window.createCanvas(1,1);const q=document.getElementById("hh"),x=document.getElementById("clap"),O=document.getElementById("bass"),$=document.getElementById("snare");L({elements:h,pattern:H}),L({elements:g,pattern:N}),L({elements:f,pattern:Y}),L({elements:w,pattern:T});const M=new p5.Phrase("hh",e=>{q.checked&&(u.play(),k.play(e))},H),R=new p5.Phrase("clap",e=>{x.checked&&D.play(e)},N),V=new p5.Phrase("bass",e=>{O.checked&&(u.play(),b.play(e))},T),G=new p5.Phrase("snare",e=>{$.checked&&(u.play(),A.play(e))},Y),U=new p5.Part;U.addPhrase(M),U.addPhrase(R),U.addPhrase(V),U.addPhrase(G);let j=new p5.Delay,z=new p5.Delay,J=new p5.Delay,Q=new p5.Delay;U.setBPM("60"),i=new p5.Reverb,i.process(k,3,2),i.process(A,3,2),i.process(D,3,2),u=new p5.Envelope,u.setADSR(.01,.8,.2,.5),u.setRange(1,.5),b.amp(u),k.amp(u),A.amp(u),D.amp(u);const W=new p5.FFT,K=(new p5.Amplitude,document.getElementById("btn")),X=document.getElementById("audioIcon"),Z=document.getElementById("spectrum"),ee=Z.getContext("2d"),te=document.getElementById("infoCount"),ne=document.getElementById("histogram"),se=document.getElementById("avgIncome"),ae=document.getElementById("stdDevIncome"),ce=document.getElementById("totalAggIncome"),re=document.getElementById("avgBinCount");I.addEventListener("change",()=>{I.checked&&(M.sequence=m,L({elements:h,pattern:m}))}),C.addEventListener("change",()=>{C.checked&&(R.sequence=p,L({elements:g,pattern:p}))}),v.addEventListener("change",()=>{v.checked&&(G.sequence=y,L({elements:f,pattern:y}))});const de=new e({portalItem:{id:"936d99f8b69246d28d6deed9461d82f7"}}),oe=a.debounce(e=>l.queryObjectIds(e).then(t=>{if(t.length)return l.effect={filter:{where:`OBJECTID in (${t.join(",")})`},excludedEffect:"grayscale(100%) opacity(30%)"},e;l.effect=null}));de.load().then(()=>{const e=de.layers.getItemAt(0);return e.outFields=["HINCBASECY","AGGHINC_CY","AVGHINC_CY","TOTHH_CY","MEDHINC_CY"],e}).then(()=>{const e=new t({map:de,container:"viewDiv"}),a=new n({content:new s({view:e})}),i=new o({container:"slider-container",excludedBarColor:"#524e4e",rangeType:"between"});e.ui.add(K,"top-left"),e.ui.add(a,"top-left"),e.ui.add(Z,"bottom-right"),e.ui.add("audioList","top-left"),e.ui.add("infoDiv","top-right"),e.ui.add(new n({content:ne}),"bottom-left"),i.labelFormatFunction=(e,t)=>"value"===t?`$${e.toFixed(0)}`:e,i.on("thumb-drag",e=>{const[t,n]=i.values,s=(n-t)/n;_.checked&&j.process(k,.12,s,n-t),P.checked&&z.process(D,.12,s,n-t),B.checked&&J.process(A,.12,s,n-t),S.checked&&Q.process(b,.12,s,n-t)}),_.addEventListener("change",e=>{_.checked?j=new p5.Delay:(j.disconnect(),j.dispose())}),P.addEventListener("change",e=>{P.checked?z=new p5.Delay:(z.disconnect(),z.dispose())}),B.addEventListener("change",e=>{B.checked?J=new p5.Delay:(J.disconnect(),J.dispose())}),S.addEventListener("change",e=>{S.checked?Q=new p5.Delay:(Q.disconnect(),Q.dispose())});const u=["MEDHINC_CY","HINC0_CY","HINC15_CY","HINC25_CY","HINC35_CY","HINC50_CY","HINC75_CY","HINC100_CY","HINC150_CY","HINC200_CY"];let H;e.when(()=>{const t=de.layers.getItemAt(0);return e.whenLayerView(t)}).then(e=>(l=e,H=l.layer.createQuery(),H.distance=5,H.units="kilometers",c.whenFalseOnce(l,"updating"))).then(()=>{e.on(["click","drag"],t=>(t.stopPropagation(),H.geometry=e.toMap(t),oe(H).then(()=>{const e=H.clone(),t=u.map(e=>({onStatisticField:e,outStatisticFieldName:`Avg_${e}`,statisticType:"avg"})),n=u.map(e=>({onStatisticField:e,outStatisticFieldName:`Var_${e}`,statisticType:"var"})),s=u.map(e=>({onStatisticField:e,outStatisticFieldName:`StdDev_${e}`,statisticType:"stddev"}));e.outStatistics=[...t,...n,...s,{onStatisticField:"TOTHH_CY",outStatisticFieldName:"Count_Est_Total",statisticType:"count"}],l.queryFeatures(e).then(({features:e})=>{if(!e.length)return;const t=e[0].attributes,{Count_Est_Total:n}=t;if(!n)return;U.setBPM(n);const[s,...a]=u,c=a.reduce((e,n)=>e+t[`StdDev_${n}`],0)/9,r=a.reduce((e,n)=>e+t[`Avg_${n}`],0)/9;m=a.map(e=>t[`Avg_${e}`]>r?1:0),y=a.map(e=>t[`StdDev_${e}`]>c?1:0),p=[];for(let e=0;e<9;e++){const t=m[e],n=y[e];let s=0;0===t&&0===n&&(s=1),p.push(s)}I.checked&&(M.sequence=m,L({elements:h,pattern:m})),v.checked&&(G.sequence=y,L({elements:f,pattern:y})),C.checked&&(R.sequence=p,L({elements:g,pattern:p})),te.innerText=n,se.innerText=r.toFixed(1),ae.innerText=c.toFixed(1)});let a=null;const c={layer:l.layer,field:"AGGHINC_CY",numBins:9,features:[]};l.queryFeatures(H).then(({features:e})=>{if(e.length)return c.features=e,function(e){return d(e).then(({avg:e})=>e)}(c)}).then(e=>(a=e,r(c))).then(e=>{if(!e)return;const{bins:t,minValue:n,maxValue:s}=e;ce.innerText=F.format(s),i.set({average:a,bins:t,min:n,max:s,values:[n,s]});const c=t.reduce((e,t)=>e+t.count,0)/t.length,r=t.map(e=>e.count>c?1:0);re.innerText=c.toFixed(1),V.sequence=r,E.checked&&L({elements:w,pattern:r})}).catch(e=>console.warn(e))})))}),K.addEventListener("click",()=>{k.isLoaded()&&D.isLoaded()&&b.isLoaded()&&(U.isPlaying?(console.log("stop music"),X.src="assets/speaker_Icon.svg",U.stop()):(console.log("start music"),X.src="assets/speaker_mute_Icon.svg",U.loop()))});let N=0;!function e(){const t=W.analyze();N=requestAnimationFrame(e),ee.fillStyle="rgb(255, 255, 255)",ee.fillRect(0,0,300,100);let n,s=0;for(let e=0;e<1024;e++)n=t[e]/2,ee.fillStyle="rgb("+(n+100)+",50,50)",ee.fillRect(s,100-n/2,.732421875,n),s+=1.732421875}()})}}));
